@{
    ViewBag.Title = "Live Monitor";
}

<h2>Live Monitor</h2>
<div id="AngularApp" ng-controller="mainCtrl">
    <!--This Div hold the Chat application, used to both communicate amongst the teams and post system notifications-->
    <div class="chatConsole">
        <div id="chatDiv" class="scrollable" style="height : 100px; overflow-y: auto;">
            <div ng-repeat="msg in messages">{{msg.message}}</div>
        </div>
        <div>
            <input ng-model="newMessage" ng-keypress="keyPress($event)" class="form-control input-sm pull-left" style="width:80%" type="text" placeholder="chat message" />
            <button ng-click="sendMessage()" class="pull-right btn btn-primary btn-sm">Send</button>
        </div>
    </div>
    <!--This Div holds the work items sent by the server-->
    <div id="workitemlist" class="col-xs-12">
        <div id="WorkItemProject" class="row">
            <div ng-repeat="workitem in workitems" class="row">
                {{workitem.Id}} : {{workitem.Project}} : {{workitem.State}} : {{workitem.ChangedDate}} : {{workitem.Title}} : {{workitem.Collection}} : {{workitem.Collection}} : {{workitem.Uri}}
            </div>
        </div>
    </div>
</div>


@section scripts {
    <!--Script references. -->
    <!--AngualrJS used for dynamic UI updates-->
    <script src="~/Scripts/angular.js"></script>
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            ////Angular Section - Create the Application And Controler
            angular.module('app', []).controller('mainCtrl', function ($scope, chat) {
                $scope.messages = [];
                $scope.workitems = [];

                //Client Side

                //Allows for enter key to be used to send messages
                $scope.keyPress = function onKeyPress($event) {
                    //13 is the enter key
                    if ($event.keyCode == 13) {
                        $scope.sendMessage()
                    }
                };

                //Sends message to server
                $scope.sendMessage = function () {
                    chat.server.send($scope.newMessage);
                    $scope.newMessage = "";
                };

                //Server Side

                //Adds a new message to chat window
                chat.client.newMessage = function onNewMessage(message) {
                    $scope.messages.push({ message: message });
                    $scope.$apply();
                    var chatDiv = document.getElementById("chatDiv");
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                    console.log(message);
                };

                chat.client.addWorkItem = function onAddWorkItem(workitem) {
                    $scope.workitems.push(workitem);
                    $scope.$apply();
                }

                chat.client.removeWorkItem = function onRemoveWorkItem(workiem) {
                    $scope.workitems.splice(workiem);
                    $scope.$apply();
                }
            });
            
            // Start the connection.
            $.connection.hub.start();
                //Now that module is made, lets start it
            $.connection.hub.error(function (err) {
                console.log('An error occurred: ' + err);
            });
            //});
            // Start angular
            //Done Defining Angular
            angular.module('app').value('chat', $.connection.chat);
            angular.bootstrap(document, ['app']);
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}