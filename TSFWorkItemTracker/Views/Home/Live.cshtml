@{
    ViewBag.Title = "Live Monitor";
}

<h2>Live Monitor</h2>

<!--This Div hold the Chat application, used to both communicate amongst the teams and post system notifications-->
<div ng-controller="mainCtrl" class="chatConsole">
    <div id="chatDiv" class="scrollable" style="height : 100px; overflow-y: auto;">
        <div ng-repeat="msg in messages">{{msg.message}}</div>
    </div>
    <div>
        <input ng-model="newMessage" ng-keypress="keyPress($event)" class="form-control input-sm pull-left" style="width:80%" type="text" placeholder="chat message" />
        <button ng-click="sendMessage()" class="pull-right btn btn-primary btn-sm">Send</button>
    </div>
</div>

<!--This Div holds the work items sent by the server-->
<div id="workitems" class="col-xs-12"></div>

@section scripts {
    <!--Script references. -->
    <!--AngualrJS used for dynamic UI updates-->
    <script src="~/Scripts/angular.js"></script>
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            ////Angular Section - Create the Application And Controler
            angular.module('app', []).controller('mainCtrl', function ($scope, chat) {
                $scope.messages = [];

                $scope.keyPress = function onKeyPress($event) {
                    //13 is the enter key
                    if ($event.keyCode == 13) {
                        $scope.sendMessage()
                    }
                };

                $scope.sendMessage = function () {
                    chat.server.send($scope.newMessage);
                    $scope.newMessage = "";
                };

                chat.client.newMessage = function onNewMessage(message) {
                    $scope.messages.push({ message: message });
                    $scope.$apply();
                    var chatDiv = document.getElementById("chatDiv");
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                    console.log(message);
                };
            });
            
            // Start the connection.
            $.connection.hub.start();
                //Now that module is made, lets start it
            $.connection.hub.error(function (err) {
                console.log('An error occurred: ' + err);
            });
            //});
            // Start angular
            //Done Defining Angular
            angular.module('app').value('chat', $.connection.chat);
            angular.bootstrap(document, ['app']);
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}